package com.example.screenreaderv2

import android.app.Activity
import android.app.AlertDialog
import android.content.Context
import android.content.Intent
import android.os.Bundle
import android.provider.Settings
import android.view.View
import android.widget.Button
import android.widget.ImageView


class MainActivity : Activity() {

    private lateinit var indicatorOn: ImageView
    private lateinit var indicatorOff: ImageView
    private lateinit var btnEnable: Button
    private lateinit var btnDisable: Button


    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        indicatorOn = findViewById(R.id.indicatorOn)
        indicatorOff = findViewById(R.id.indicatorOff)
        btnEnable = findViewById(R.id.btnEnableAccessibility)
        btnDisable = findViewById(R.id.btnDisableAccessibility)

        btnEnable.setOnClickListener { showEnableDialog() }
        btnDisable.setOnClickListener { showDisableDialog() }

        indicatorOn.setOnLongClickListener {
            startActivity(Intent(this, MonitorActivity::class.java))
            true
        }
    }

    override fun onResume() {
        super.onResume()
        updateIndicators()
    }

    // =========================
    // Accessibility State Check
    // =========================

    private fun isAccessibilityEnabled(context: Context): Boolean {
        val expectedService =
            "${context.packageName}/${PerceptionAccessibilityService::class.java.name}"

        val enabledServices = Settings.Secure.getString(
            context.contentResolver,
            Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES
        ) ?: return false

        return enabledServices.contains(expectedService)
    }

    private fun updateIndicators() {
        if (isAccessibilityEnabled(this)) {
            indicatorOn.visibility = View.VISIBLE
            indicatorOff.visibility = View.GONE
        } else {
            indicatorOn.visibility = View.GONE
            indicatorOff.visibility = View.VISIBLE
        }
    }

    // =========================
    // Enable / Disable Dialogs
    // =========================

    private fun showEnableDialog() {
        if (isAccessibilityEnabled(this)) return

        AlertDialog.Builder(this)
            .setTitle("Enable Accessibility Service")
            .setMessage(
                "This app requires Accessibility Service to function.\n\n" +
                        "Please enable the service from system settings."
            )
            .setPositiveButton("OK, Activate") { _, _ ->
                openAccessibilitySettings()
            }
            .setNegativeButton("No, Thanks", null)
            .show()
    }

    private fun showDisableDialog() {
        if (!isAccessibilityEnabled(this)) return

        AlertDialog.Builder(this)
            .setTitle("Disable Accessibility Service")
            .setMessage(
                "Accessibility Service cannot be disabled automatically.\n\n" +
                        "You will be redirected to system settings to disable it manually."
            )
            .setPositiveButton("Go to settings") { _, _ ->
                openAccessibilitySettings()
            }
            .setNegativeButton("Cancel", null)
            .show()
    }

    private fun openAccessibilitySettings() {
        startActivity(Intent(Settings.ACTION_ACCESSIBILITY_SETTINGS))
    }
}